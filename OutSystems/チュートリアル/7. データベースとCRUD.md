# データベースを作成し、検索履歴を管理しよう
[前章](https://github.com/taijihagino/low-code-dev/blob/main/OutSystems/%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB/6.%20Leaflet%20Map%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E5%9C%B0%E5%9B%B3%E3%82%A2%E3%83%97%E3%83%AA.md)では、Leaflet Mapを配置し、検索した住所にMarker（ピン）を立てる、ということを実装しました。

ここでは、その検索結果のデータをデータベースに保存し、別画面（Screen）で参照する、という機能を実装していきます。

## Entityの作成
１．Dataタブを選択し、Module → Entity → Databaseを右クリックして「Add Entity」を選択します。

<img width="514" alt="Screenshot 2024-01-20 at 21 58 22" src="https://github.com/taijihagino/low-code-dev/assets/12064399/36ffa3d7-8795-42b9-8ed6-88c5bd088fcd">


２．作成したEntityの名前を「History」にします。

<img width="311" alt="Screenshot 2024-01-20 at 21 59 07" src="https://github.com/taijihagino/low-code-dev/assets/12064399/86809aa7-a664-47f2-9252-c47bea9d907b">


３．HistoryにRenameしたEntityを右クリックして「Add Entity Attribute」を選択します。

<img width="389" alt="Screenshot 2024-01-20 at 22 00 16" src="https://github.com/taijihagino/low-code-dev/assets/12064399/1f4caad6-ae4b-4fdf-8f4c-ce89c297e013">


４．作成したAttributeの名前を「UserId」にします。そうすると、OutSystemsが自動で判断して、既存のUser TableにあるUserIdに対して外部キーを貼ってくれます。

<img width="307" alt="Screenshot 2024-01-20 at 22 01 00" src="https://github.com/taijihagino/low-code-dev/assets/12064399/0bc23ff6-564e-4698-9f58-ac61b88c8425">


５．同様の手順で、以下のEntity Attributeを作成します。

- Timestamp
- Zipcode
- City
- Lat
- Long

Timestampだけ、Data Typeを「Date Time」型にします。その他のAttributeは「Text」型のままでOKです。

<img width="307" alt="Screenshot 2024-01-20 at 22 05 19" src="https://github.com/taijihagino/low-code-dev/assets/12064399/2f0c0f06-4887-4195-942b-f22bee768691">


これで、Entityの作成は完了です。

## データ保存処理をサーバーアクションとして作成
１．Interfaceタブを選択し、Module → UI Flows → Main Flow → Mapの「OnClick」をダブルクリックしてボタンアクションの編集画面を表示します。既存のフローの中にある「GetAdress」を ```Ctl+X / Cmd+X``` で切り取ります。（もしくはコピーして削除します）

<img width="1512" alt="Screenshot 2024-01-20 at 22 19 42" src="https://github.com/taijihagino/low-code-dev/assets/12064399/613a6f7f-b7ed-4664-9760-fd050b4c1667">


２．Logicタブを選択し、Module → Server Actionを右クリックして「Add Server Action」を選択します。

<img width="485" alt="Screenshot 2024-01-20 at 22 22 18" src="https://github.com/taijihagino/low-code-dev/assets/12064399/3fb399f8-b79a-4e05-870d-6e3ffd2f2703">


３．作成したServer Actionを「CallGeoapi」にRenameします。CallGeoapiのアクション編集画面にて、先程切り取ったGetAdressを ```Ctl+P / Cmd+P``` で貼り付けて、フローのStartとEndの間に配置します。

<img width="1512" alt="Screenshot 2024-01-20 at 22 23 15" src="https://github.com/taijihagino/low-code-dev/assets/12064399/5943e88f-a791-4264-98cc-6885ca96fdea">


４．CallGeoapiを右クリックして「Add Input Parameter」を選択します。作成したInput Parameterは「zipcode」という名称に変更します。

<img width="406" alt="Screenshot 2024-01-20 at 22 35 29" src="https://github.com/taijihagino/low-code-dev/assets/12064399/3736b646-d121-4523-90d2-43c7ca6ef46a">


５．Interfaceタブを選択し、Module → UI Flows → Main Flow → Mapの「OnClick」をダブルクリックしてボタンアクションの編集画面を表示します。既存のフローの中にあるStartとListAppendの間にLogicタブから「CallGeoapi」をドラッグ＆ドロップで配置します。

<img width="1501" alt="Screenshot 2024-01-20 at 22 24 59" src="https://github.com/taijihagino/low-code-dev/assets/12064399/33459fb1-2601-4e3b-8d7c-27a18b532f25">


６．配置したCallGeoapiをダブルクリックして、アクション編集画面を開きます。DataタブのModule → Entities → Database → Historyの配下にCRUDの処理が生成されているのが確認できます。その中から「CreateHistory」を選択し、ドラッグ＆ドロップで既存フローのGetAddressとEndの間に配置します。

<img width="1512" alt="Screenshot 2024-01-20 at 22 26 40" src="https://github.com/taijihagino/low-code-dev/assets/12064399/310cced6-608a-41ab-bec1-a63528c4aeaa">


７．フローに配置したCreateHistoryに「Source」を設定します。CreateHistoryは、Historyのテーブルに、データを追加する処理です。そのため、追加データをどこから持ってくるか（つまりSource）を設定する必要があるのです。「Source」をダブルクリックしてExpression Editorを開きます。次の値を設定します。

```GetAddress.Response.Response.Location.Current```

<img width="1333" alt="Screenshot 2024-01-20 at 22 28 33" src="https://github.com/taijihagino/low-code-dev/assets/12064399/e27f1c68-55ea-421e-ab0d-a93ecaf351ae">

そうすると、実際に「CreateHistory」でInsert処理に必要な項目それぞれにどの値を設定するかを指定するためのパネルが出現します。以下のように設定してください。

- Id：NullIdentifier()
- UserId：GetUserId()
- Timestamp：CurrDateTime()
- Zipcode：zipcode
- City：GetAddress.Response.Response.Location.Current.City
- Lat：GetAddress.Response.Response.Location.Current.Y
- Long：GetAddress.Response.Response.Location.Current.X

IdからTimestampまでは、プルダウンにSuggestionで出てくると思います。<br>
Zipcode、City、Lat、Longは、Expression Editorを使って設定します。以下の画像を参照してください。

<img width="1131" alt="Screenshot 2024-01-20 at 22 39 00" src="https://github.com/taijihagino/low-code-dev/assets/12064399/10cb56f7-20af-46fd-9ed4-e472ef8972af">

<img width="1141" alt="Screenshot 2024-01-20 at 22 38 41" src="https://github.com/taijihagino/low-code-dev/assets/12064399/9fc5436d-a641-4f13-89f6-5e271cf84a47">

<img width="1130" alt="Screenshot 2024-01-20 at 22 40 26" src="https://github.com/taijihagino/low-code-dev/assets/12064399/73f926d4-3157-4ecf-a23e-efe9efd0cf59">

<img width="1130" alt="Screenshot 2024-01-20 at 22 40 49" src="https://github.com/taijihagino/low-code-dev/assets/12064399/8abe5e35-56ee-4f47-a03b-37b8664c9b0a">



## ボタンアクションにデータ保存処理を追加


## 検索履歴表示画面（Screen）の追加


# まとめ
